<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    </head>
  <body>
    <div id="wrap">
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		<li><a href="/blog/projects.html">Projects</a></li>
		<li><a href="/blog/astronomy.html">Astronomy</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
				<li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/groovy.html">Gradle</a></li>
				<li><a href="/blog/2013/07/30/deck2pdf_exporting_html5_slide_decks.html">deck2pdf</a></li>
				<li><a href="/blog/tags/jlangdetect.html">JLangDetect</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://twitter.com/CedricChampeau"><i class="fa fa-twitter"></i></a>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">

	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="/blog/2019/09/introverti-teletravail.html"><h1>Chroniques d&#8217;un introverti en télétravail</h1></a>
  			<p>29 septembre 2019</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/télétravail.html">télétravail</a> 
	
		<a href="/blog/tags/introversion.html"> introversion</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>L&#8217;autre jour j'écoutais le podcast <a href="https://lescastcodeurs.com/2019/09/16/lcc-216-l-episode-ou-on-a-perdu-le-compte/">Les Cast Codeurs</a> qui abordait le sujet du télétravail.
Quelques remarques m&#8217;ont fait tiquer, je m&#8217;en vais donc ici vous raconter mon expérience, mais surtout vous parler de moi et de l&#8217;introversion.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_t_l_travail_et_l_introversion">Le télétravail et l&#8217;introversion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Voici maintenant presque 10 ans que je suis presque à 100% en télétravail. Je dis presque, parce qu&#8217;en pratique, j&#8217;ai quelques déplacements professionnels (conférences, meetings) de temps en temps, mais pour mon boulot de tous les jours, c&#8217;est tout à la maison.
Avant de faire du télétravail, je roulais beaucoup: mon emploi était sur Nantes, à 45km de chez moi. Ca faisait donc 90km par jour, mais surtout entre 2 et 3h de transport par jour (eh oui, j&#8217;avais la chance de devoir traverser le pont de Cheviré, pour ceux qui connaissent&#8230;).
Bref, le jour où j&#8217;ai changé d&#8217;emploi, pour passer chez VMware pour travailler sur le langage Groovy, le premier choc pour moi ça a été de récupérer ces 2 ou 3 heures par jour.
C&#8217;est autant de temps qu&#8217;on peut passer à s&#8217;occuper de ses enfants (les déposer à l'école, les emmener au sport, &#8230;) ou à faire des activités à la maison (jardinage, sport, &#8230;).
Je ne reviendrais pas sur ces aspects, parce qu&#8217;ils sont largement connus, le seul "inconvénient" pour moi étant surtout d'être capable de maîtriser ses horaires, c&#8217;est à dire de ne pas, contrairement à ce qu&#8217;on pense, faire <em>trop</em> d&#8217;heures !</p>
</div>
<div class="paragraph">
<p>Non, ce sur quoi je veux revenir, c&#8217;est cette remarque d&#8217;Antonio Goncalvés, qui, en conseil, dit en substance:</p>
</div>
<div class="paragraph">
<p>"Balancez votre cafetière, sortez dans les bars, voyez des gens, c&#8217;est important de voir des êtres humains!"</p>
</div>
<div class="paragraph">
<p>Et ceci <a href="https://twitter.com/CedricChampeau/status/1173893698997936130">m&#8217;a fait réagir</a>, j&#8217;aimerais donc revenir sur le sujet.
Tout d&#8217;abord, revenons sur le fait que ce conseil ne fonctionne que si vous habitez en ville, ce qui n&#8217;est pas mon cas.
Je suis en campagne, à 5km du bourg, donc faire une "pause café", ça prend du temps dans ces conditions.</p>
</div>
<div class="paragraph">
<p>Mais revenons surtout sur le fond du sujet: "C&#8217;est important de voir des êtres humains", ou ce <em>besoin de ne pas être seul</em>.
C&#8217;est un sujet qui me tient à coeur et qui résonne avec une des questions que j&#8217;ai souvent lorsque je parle du télétravail:</p>
</div>
<div class="paragraph">
<p>"Mais tu n&#8217;en as pas marre d'être tout seul, de ne voir personne ?"</p>
</div>
<div class="paragraph">
<p>Alors, répondons franchement: <strong>non</strong>.</p>
</div>
<div class="paragraph">
<p>Autant je comprends les personnes qui en ont besoin, autant, <strong>ne croyez pas que tout le monde fonctionne comme vous</strong> et a <em>besoin</em> de voir du monde.
Certaines personnes, comme moi, vivent très bien sans voir personne.
Je peux passer des journées entières seul, sans que celà ne me pose le moindre problème, ni ne me cause le quelconque manque de relations humaines.</p>
</div>
<div class="paragraph">
<p>Je vais partie de cette catégorie de population qu&#8217;on appelle les <em>introvertis</em>.</p>
</div>
<div class="paragraph">
<p>Un <em>introverti</em>, contrairement à une croyance populaire, ça n&#8217;est pas un associal, un égoïste ou quelqu&#8217;un sans empathie.</p>
</div>
<div class="paragraph">
<p>Un <em>introverti</em>, c&#8217;est quelqu&#8217;un dont l'énergie sera drainée par la foule, par les relations inter-personnelles, c&#8217;est l&#8217;opposé d&#8217;un <em>extraverti</em> qui a besoin de monde pour regagner de l'énergie.</p>
</div>
<div class="paragraph">
<p>Un <em>introverti</em>, c&#8217;est quelqu&#8217;un qui ne supportera pas les conversations de comptoir, parce qu&#8217;elles ne lui apportent rien d&#8217;autre qu&#8217;une perte d'énergie.</p>
</div>
<div class="paragraph">
<p>Un <em>introverti</em>, c&#8217;est quelqu&#8217;un qui pourra vous tenir une conversation passionnée sur un sujet qui l&#8217;intéresse, parce qu&#8217;il en retire quelque chose: l&#8217;interaction en vaut la chandelle.</p>
</div>
<div class="paragraph">
<p>Déja tout petit, j'évitais les groupes, je n&#8217;avais pas beaucoup d&#8217;amis (mais ceux que j&#8217;avais à l'époque, je les ai toujours).
J&#8217;ai toujours eu une peur bleue de me retrouver dans un groupe où je ne connaissais personne, que ce soit à l'école, au sport, &#8230;
Mais même si je connaissais quelqu&#8217;un, se retrouver <em>dans un groupe</em>, à devoir cultiver des relations proches, extra "professionnelles", était d&#8217;une extrême complexité pour moi (et ça l&#8217;est toujours).
Tout ce qui m&#8217;importait à l'époque, c'était d&#8217;apprendre, être "fort" à l'école, ce qui m&#8217;a valu d'être traité "d&#8217;intello", parfois chahuté, ou d&#8217;avoir des remarques pas particulièrement gentilles d&#8217;autres élèves au dos de ma photo de classe, ceci pendant une grande partie de mon enfance&#8230;</p>
</div>
<div class="paragraph">
<p>Par exemple, j&#8217;ai toujours refusé les camps de vacances (ma seule expérience, une semaine à faire du cheval, fût tellement une horreur pour moi que je m&#8217;en souviens encore).
J&#8217;ai aussi refusé toutes les classes de neige.
En revanche, j&#8217;avais accepté d&#8217;aller en voyage scolaire en Angleterre, en Irlande, en Espagne, non sans lutter contre moi-même, parce que je savais que je pouvais en tirer quelque chose, mais aussi parce que j&#8217;avais la garantie de me retrouver en petit nombre, avec un copain, dans une chambre&#8230;</p>
</div>
<div class="paragraph">
<p>Dans la même veine, devoir se retrouver au tableau pour réciter une poésie, ou, pire, chanter, tenait de la torture.
J&#8217;ai adoré la fac' de sciences, parce que je pouvais passer du temps au "café" avec 2/3 potes maximum, à discuter.
J&#8217;ai détesté mon école d&#8217;ingénieur, où j&#8217;ai du rivaliser d&#8217;astuces pour éviter les soirées d&#8217;intégration, tonus et autres dont étaient friants 95% des étudiants: se faire reconnaître sans se faire exclure (mais j&#8217;ai encore trouvé quelques bons amis que je tiens de cette époque).</p>
</div>
<div class="paragraph">
<p>Aaah, les soirées d&#8217;intégration: ce qui est marrant pour certains, se bourrer la gu&#8230;, humilier "gentilement" les autres, c'était juste pour moi quelque chose d&#8217;horrible.
Tiens, d&#8217;ailleurs, peu le savent, mais j&#8217;ai fait toute ma scolarité à Nantes, non pas parce que tout était disponible là bas (c'était le case), mais parce que j'était terrifié à l&#8217;idée de me retrouver seul dans une FAC, une école d&#8217;ingénieur, à l&#8217;autre bout de la France&#8230;
Certains profs m&#8217;avaient reproché de ne pas tenter une "Grande Ecole", mais je pense qu&#8217;au final, je m&#8217;en suis plutôt bien sorti !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jamais_je_n_embaucherais_quelqu_un_comme_vous">Jamais je n&#8217;embaucherais quelqu&#8217;un comme vous!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ceci pourrait vous paraitre surprenant pour quelqu&#8217;un qui, aujourd&#8217;hui, donne des conférences devant, parfois, des centaines de personnes.
Mais alors, quelle est la différence ?</p>
</div>
<div class="paragraph">
<p>La différence, c&#8217;est que lorsque je vous parle dans un cadre professionnelle, <strong>je maîtrise mon sujet</strong> (ou je pense le maîtriser, ah ah !).
Je peux vous parler ouvertement, parce que je sais que les questions qu&#8217;on va me poser seront sur ce sujet.
Il n&#8217;y a que peu de place à l&#8217;inconnu.</p>
</div>
<div class="paragraph">
<p>C&#8217;est aussi pour celà qu&#8217;il m&#8217;est très difficile, encore aujourd&#8217;hui, d&#8217;aborder des gens que je ne connais pas.
Je ne sais pas faire de "small talk", comme on dit.
Mais ça va plus loin: j&#8217;ai fais pas mal de déplacements à l'étranger, aux US par exemple, mais JAMAIS, je ne suis sorti seul pour visiter (au mieux je marcherai une heure ou deux dans les alentours).
On rentre dans cette zone d&#8217;inconnu qui me met tellement mal à l&#8217;aise : devoir s&#8217;adresser à des gens, qui plus est à l'étranger, pour commander un plat, pour demander son chemin: celà me demande trop d&#8217;efforts, me draine trop.
En revanche, si je connais une ou deux personnes et qu&#8217;elle me proposent de les accompagner, ça se passera bien: j&#8217;apprécie fortement une sortie en "petit comité".
Tout le monde me dit que j&#8217;ai tellement de chance de partir voyager, voir du pays, mais moi, je déteste tellement voyager, en tout cas sans ma famille&#8230;
Rien qu&#8217;aller à Paris, me rendre compte du nombre de personnes qui vivent là bas, me sentir étouffer, qu&#8217;est-ce que j&#8217;ai horreur de ça !</p>
</div>
<div class="paragraph">
<p>La conséquence, c&#8217;est que je fuis comme la peste les "soirées" comme les speaker dinner, les événements d&#8217;entreprise, &#8230;
Souvent, on les présente comme des incontournables du "réseautage", et c&#8217;est vrai qu&#8217;on y apprend souvent des choses intéressantes, mais elles sont extrêmement stressantes pour moi.
La plupart du temps, j&#8217;essaie de trouver une tête connue et je "m&#8217;accroche", mais je ne fais jamais long feu.
Ce qui me terrorise s&#8217;est d&#8217;en arriver à des sujets extra-professionnels, là où je n&#8217;ai AUCUNE "compétence".
Certains diront que je suis chiant, que je n&#8217;ai aucun intérêt, et c&#8217;est probablement vrai si vous recherchez quelqu&#8217;un à la vie extraordinaire, la mienne n&#8217;est pas ultra passionnante :)</p>
</div>
<div class="paragraph">
<p>Si vous en arrivez là, vous devez vous dire que je ne dois pas être un très bon "team player", comme on dit.
Paradoxalement je ne pense pas que ce soit le cas.
En effet, il ne faut pas confondre mon incapacité à avoir des relations inter-personnelles "simples" avec la capacité d'échange, d&#8217;interaction professionnelle, qui est sur une toute autre dimension.</p>
</div>
<div class="paragraph">
<p>Comme je vous l&#8217;ai expliqué, je donne régulièrement des talks, et j&#8217;adore plus que tout partager ces connaissances, aider les autres.
J&#8217;aime aussi travailler avec des gens plus compétents que moi pour avoir l&#8217;autre face de la pièce: apprendre, comprendre de nouvelles choses, progresser.
Et dans ce contexte, travailler en équipe aide énormément.</p>
</div>
<div class="paragraph">
<p>Alors, ce n&#8217;est pas parce qu&#8217;on est en télétravail et qu&#8217;on ne voit personne qu&#8217;on travaille <em>seul</em>.
Non, on est en équipe. On fait des "daily standup" (via Hangout/Slack), on s&#8217;organise, on fait des petites réunions "face to face" de temps en temps, bref, je pense, mes collègues vous le diront si ça n&#8217;est pas le cas, que ça se passe plutôt bien.</p>
</div>
<div class="paragraph">
<p>Bref, n&#8217;ayez pas peur de cet aspect: la solitude n&#8217;est pas, pour tout le monde, un problème.
Elle peut, au contraire, aider à la productivité: pas de réunionite inutile, capacité à se focaliser sur un problème des heures durant, &#8230;
Elle n&#8217;est pas, non plus, signe de quelqu&#8217;un qui ne peut pas travailler en équipe: ça n&#8217;empêche en RIEN d&#8217;aider ses collègues, ses clients, bien au contraire: puisqu&#8217;on sait que la relation est professionnelle, elle est focalisée et bien plus efficace.</p>
</div>
<div class="paragraph">
<p>Pour vous donner une idée, chez Gradle, tout le monde est en télétravail.
Mais pour cet aspect "socialisation", nous avons une réunion hebdomadaire, facultative, appelée "coffee time" où chacun peut rejoindre la réunion et parler de sujets extra-professionnels.
Certains en ont besoin, pas moi.
Au contraire, j&#8217;aurais du mal à arriver à cette réunion et savoir de quoi parler.
Pire, j'évite au maximum d&#8217;arriver en premier à une réunion de peur de ne pas savoir engager une conversation&#8230;</p>
</div>
<div class="paragraph">
<p>Mais encore une fois: parlez moi d&#8217;un sujet que je maîtrise, demandez moi d&#8217;expliquer un problème, de chercher une solution, d&#8217;aider quelqu&#8217;un: il n&#8217;y aura aucun problème, parce qu&#8217;il n&#8217;y a aucune place à l&#8217;inconnu.
Il est même fort probable que j&#8217;apprécie énormément une conversation entre nous: si je ne viens pas vous voir, ça n&#8217;est pas que je ne souhaite pas vous parler, c&#8217;est que même si je vous connais, engager une conversation reste quelque chose de très compliqué pour moi. Venez me voir, engagez la conversation et tout se passera bien ! :D</p>
</div>
<div class="paragraph">
<p>Alors, ne vous étonnez pas si je vais trois fois le tour du quartier plutôt que de demander mon chemin.
Ne vous étonnez pas si je ne téléphone jamais, ne texte jamais.</p>
</div>
<div class="paragraph">
<p>Mais si vous faites partie de mes amis, vous avez énormément de chance: c&#8217;est que je tiens beaucoup à vous et vous tiens en haute estime !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_n_ayez_pas_honte_d_tre_introvertis_faites_comprendre_ce_que_c_est">N&#8217;ayez pas honte d'être introvertis, faites comprendre ce que c&#8217;est</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Je terminerais pas une remarque: dans mon <a href="https://twitter.com/CedricChampeau/status/1173893698997936130">Tweet original</a>, je disais que je "me soignais".
C&#8217;est vrai et c&#8217;est faux à la fois.
Quand je dis que c&#8217;est vrai, c&#8217;est parce que conscient de l&#8217;importance et de la "non reconnaissance" de cette difficulté par les autres, j&#8217;essaie de travailler, notamment la prise de parole.
Je suis, par exemple, secrétaire du club de Karaté, ce qui me force à communiquer avec des gens que je ne connais pas.
Je suis aussi le coach de l'équipe de basket de mon fils de 10 ans, ce que j&#8217;adore faire: c&#8217;est une activité avec son enfant, qui est à la fois publique, mais aussi tellement gratifiante, voir ces enfants heureux de jouer, gagner, &#8230; et ça me permet de travailler sur les relations avec les parents !</p>
</div>
<div class="paragraph">
<p>Et surtout, c&#8217;est aussi un message pour mon fils, qui a 10 ans donc mais me ressemble tellement: il a lui aussi beaucoup de mal à parler aux gens, mais je qu&#8217;il travaille dur pour se faire accepter. Lui aussi est si fier lorsqu&#8217;il a la reconnaissance de ses pairs&#8230; Il m&#8217;a fallu des années avant de mettre un nom à ce que je suis, un <em>introverti</em>, et aujourd&#8217;hui encore, je lutte pour ne plus en avoir <em>honte</em>.</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2019/09/introverti-teletravail.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2019/07/dependency-management.html"><h1>Dependency Management at Gradle</h1></a>
  			<p>11 juillet 2019</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/gradle.html">gradle</a> 
	
		<a href="/blog/tags/dependency-management.html">dependency management</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Opinions are my own, not those of my employer</em></p>
</div>
<div class="paragraph">
<p>I joined Gradle 4 years ago, and I spent the last 2 years almost exclusively working on <em>dependency management</em>.
The more I work on this topic, the more I am frustrated by the state of our industry.
In this blog post I will mostly illustrate my points with Java, which I&#8217;m mostly familiar with, but a lot of them stand true whatever the ecosystem (Javascript, Python, Go, &#8230;).</p>
</div>
<div class="paragraph">
<p>Soon, we should release Gradle 6 (fall 2019, no promise, as always, this is software).
This version will be the first one to turn the spotlights on <em>dependency management</em>.
This will be for me the achievement of 2 hard years of work (not alone, of course) but this is <em>just</em> the beginning.
Gradle probably has the most advanced dependency engine of the market (forgive me if I&#8217;m wrong, let me know).
But what makes it so different is not that it has powerful features like dependency substitution, customizable resolution, dependency locking, alignment, etc&#8230;
No, what makes it different it&#8217;s that we put a lot of emphasis on <em>semantics</em>: model software correctly so that you, as a developer, have less to handle.</p>
</div>
<div class="paragraph">
<p>Often, folks "from the outside" are considering us <em>arrogant</em>, because we don&#8217;t immediately support things that other engines do (eg. "you don&#8217;t want to implement optional dependencies, look, Maven has it for years you s***").
While I understand the frustration, it doesn&#8217;t mean that we don&#8217;t hear.
In fact, we hear you loud, but the time it takes to land is just the consequence of willing to implement the correct solution to a problem.</p>
</div>
<div class="paragraph">
<p>For example, what does an <em>optional dependency</em> mean?
A few months ago, I read this from the Yarn documentation which got me scared, and, to be honest, a bit despaired too:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/optional-deps-yarn.png" alt="optional deps yarn">
</div>
</div>
<div class="paragraph">
<p>This looks like total non-sense to me.
Because we needed the infrastructure, it took some time but we implemented what we think is a <em>better</em> solution.
In a nutshell, optional dependencies are <em>not optional</em>.
They are things that you need <em>if you use a particular feature of a library</em>.
So it means that if you depend on something, and that this something has <em>optional features</em>, you can say what features you need and Gradle would give you the correct dependencies for this.
We called that <a href="https://docs.gradle.org/current/userguide/feature_variants.html">feature variants</a>. Granted, the name isn&#8217;t cool, but it&#8217;s a matter of time until we refactor the documentation to make it easier to discover.</p>
</div>
<div class="paragraph">
<p>Similarly, we implemented back in Gradle 3.4 the separation of API and implementation dependencies for the Java world.
In fact, that&#8217;s one of the reasons the <code>compile</code> configuration has been "soft deprecated" for years now, and that we&#8217;re going to nag you starting from Gradle 6.
I still hear people claiming they don&#8217;t need this and that it&#8217;s hard to understand but I stand by the fact they <em>deperately</em> need them.</p>
</div>
<div class="paragraph">
<p>Why is it important? Because if you are a library author, you know that there are things that are "your internal sauce": things which are implementation details, not part of the public API, and that should never be exposed to consumers.
This is the very reason Java 9 shipped with the module system: strong encapsulation.
However, how does it work for dependencies? There are also dependencies which are <em>part of your API</em> and others which are not.
Say you use Guave internally. None of the Guava classes are visible on your public API, and it would be an error to do so.
Then it means that Guava <em>is an implementation dependency of your library</em>.
When you do this, you should be allowed to replace Guava with something else at any time, without breaking any of your consumers.
The horrible reality is that if you use the Maven <code>&lt;compile&gt;</code> scope, those dependencies are going to <em>leak</em> to the consumers, and they could accidentally start using Guava just because it&#8217;s available on the classpath (yeah, IDEs love this, the class is available for completion you know!).</p>
</div>
<div class="paragraph">
<p>This is a problem with Maven because the POM file is used for 2 distinct purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>representing the point of view of the producer, where <code>&lt;compile&gt;</code> means "I need this on my compile classpath"</p>
</li>
<li>
<p>representing the point of view of the consumer, where <code>&lt;compile&gt;</code> semantics are there broken: it means "add this to your compile classpath", but it means you leak dependencies which should have been on the <code>&lt;runtime&gt;</code> scope!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With the Gradle <a href="https://docs.gradle.org/current/userguide/java_library_plugin.html">Java Library plugin</a>, those issues <em>go away</em>: we model those correctly, and when we generate a POM file, it has dependency declarations which <em>make sense for the consumer</em>.
I&#8217;ve been battling to explain this in conferences for years, yet, lots of people don&#8217;t get how harmful to the whole ecosystem that design decision from Maven was: it just prevents smooth dependency upgrades, and contributes to the "classpath explosion".</p>
</div>
<div class="paragraph">
<p>In other words, you, as a developer, should <em>always know what you directly use</em> (your first level dependencies).</p>
</div>
<div class="paragraph">
<p>As another example, we&#8217;ve been yelling for years how bad exclusions are, but we did a really bad job at explaining <em>why</em>.
The problem is also that we didn&#8217;t have all the tools we needed to workaround them, so we said "yeah it&#8217;s bad" but didn&#8217;t really say that you can still use them in some cases.</p>
</div>
<div class="paragraph">
<p>In a nutshell, an <em>exclusion</em> is bad because the dependency resolution engine doesn&#8217;t know <em>why</em> you excluded a dependency:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>is it because the producer had bad metadata, that the dependency should have been "optional", or just absent altogether?</p>
</li>
<li>
<p>is it because you don&#8217;t use a specific <em>code path</em> of a dependency and you just want to slim down the size of your distribution?</p>
</li>
<li>
<p>is it because <em>something breaks</em> if you use this dependency?</p>
</li>
<li>
<p>is it because it&#8217;s yet another logger on the classpath and this is not the one you use?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Well, again, for all those use cases, the solutions are <em>different</em>.
The logging use case is an illustration of this: how many of you have faced this infamous problem of having multiple SLF4J bindings on the classpath?
How do you fix that with Maven? Exclude of course!</p>
</div>
<div class="paragraph">
<p>But wouldn&#8217;t it better if you could express that "between all those logger bindings, this is the one I choose".
Wouldn&#8217;t it better if, as a <em>producer</em> of a logger binding, you could say "I implement this logger API, and it doesn&#8217;t make sense to have multiple logger bindings on the classpath at the same time".
Well, this is what Gradle offers you, as a producer and as a consumer.</p>
</div>
<div class="paragraph">
<p>Modeling software is important, because it makes the industry better <em>as a whole</em>.
By explaining <em>why</em> instead of <em>how</em>, <strong>the dependency management engine can take better decisions</strong>.
It can fail if things are incompatible, it can ask you to choose between different implementations.</p>
</div>
<div class="paragraph">
<p>Do you need another example? Look at all those "Maven classifiers". How many times did you got multiple conflicting implementations of the same thing <em>just because they had different classifiers</em> (looking at you, Guava!).</p>
</div>
<div class="paragraph">
<p>The reality is that a classifier is a workaround for a bad model, incapable of expressing that you have different <em>things</em> published at the same coordinates.
Sometimes I read comments like "Gradle is just Maven with a Groovy DSL".
This is wrong at so many levels: Gradle empathizes on <em>strong modelling</em> of software.
We need to think in terms of components ("this is a library", "this is a Boot application", "this is a Gradle plugin"), not in terms of <em>conventions</em>.
Models are orthogonal to conventions: conventions are just a tool to make modelling easier to implement, but what matters is the model.
The DSL also doesn&#8217;t matter: Groovy, Kotlin, whatever. What makes Gradle powerful is that it <em>understands what you build</em>.</p>
</div>
<div class="paragraph">
<p>This is one of the reasons we came with <a href="https://blog.gradle.org/gradle-metadata-1.0">Gradle Module Metadata</a>, which is going to be enabled by default in Gradle 6.</p>
</div>
<div class="paragraph">
<p>We, at Gradle, think that we can save a lot of developer time by simply putting more sense in those things we publish.
It&#8217;s a waste of time and energy that we all have to fix, constantly, those conflicts between libraries.</p>
</div>
<div class="paragraph">
<p>And can we talk about ethics?
It&#8217;s beyond me we can tolerate, as developers/engineers, repeated approximations, errors, just <em>because Maven does it this way</em>?
I don&#8217;t really care that we&#8217;re <em>not compatible with Maven</em>, as long as we <em>solve the problem</em> and that we move towards well designed, better solutions.
Sometimes we have to make tradeoffs, but we can&#8217;t compromise on reproducibility, correctness and performance.
Of course, we do our best to provide Maven compatibility, and again, sometimes make it even better in some situations (the Java Library plugin).</p>
</div>
<div class="paragraph">
<p>My goal is that we, as a whole, move towards a better software delivery world.</p>
</div>
<div class="paragraph">
<p>The good thing is that what we&#8217;re not alone.
This, is the result of years of experience from the team with very large builds, from customers of small to very large organizations, and discussions with talented open-source developers (special thanks from me to <a href="https://twitter.com/ankinson">Andy Wilkinson</a> from the Spring team).</p>
</div>
<div class="paragraph">
<p>I posted this earlier this month on Twitter, this is a <em>real</em> dependency graph, from an organization I have the opportunity to work with:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/real-dependency-graph.png" alt="real dependency graph">
</div>
</div>
<div class="paragraph">
<p>This is not uncommon, this is the reality we live in.</p>
</div>
<div class="paragraph">
<p>And when you have such a dependency graph, you desperately need more modelling.
Does it mean that Gradle is perfect? Hell, no. We&#8217;re going to make mistakes, we already have and we will continue, but what matters is that we&#8217;re moving towards our goal.</p>
</div>
<div class="paragraph">
<p>There are lots of good things coming in Gradle 6, stay tuned. In the meantime, a lot of what I discussed here has been presented in a couple of webinars:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://gradle.com/blog/dependency-management-fundamentals/">Dependency Management fundamentals with Gradle</a></p>
</li>
<li>
<p><a href="https://gradle.com/blog/dependency-management-part-2-handling-conflicts/">Handling Conflicts and Customizing Resolution</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Another webinar is planned after summer, around multi-repository development.</p>
</div>
<div class="paragraph">
<p>Hope you&#8217;ll enjoy!</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2019/07/dependency-management.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2019/03/goodbye-groovy.html"><h1>Goodbye, Groovy!</h1></a>
  			<p>21 mars 2019</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/gradle.html">gradle</a> 
	
		<a href="/blog/tags/groovy.html">groovy</a> 
	
		<a href="/blog/tags/kotlin.html">kotlin</a> 
	</p>
			
  			<p><div class="sect1">
<h2 id="_i_m_stepping_down_from_the_apache_groovy_project">I&#8217;m stepping down from the Apache Groovy project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Today is a very sad day. I&#8217;ve decided to resign from the Apache Groovy PMC, as well as a committer.</p>
</div>
<div class="paragraph">
<p>The trigger was that I <a href="https://github.com/apache/groovy/commit/56c219eca0c028c95713a3abd74f14fa40cb0e6c">dared pushing a Gradle Kotlin DSL</a> and this had to be reverted.
Lots of people in the Groovy community see Kotlin as a threat. I don&#8217;t. I use both languages everyday, for different purposes.
I wrote most of the static compiler for Groovy, and I have no problem saying that I believe Kotlin is better as a static language: the experience is more consistent, and very pleasant.
But nothing in Kotlin reaches the simplicity that Groovy offers. Running a single line script, the awesome Spock framework for testing, &#8230;</p>
</div>
<div class="paragraph">
<p>The fact I work for Gradle Inc was also mentioned as a reason why I did push this file.
To me, this is questioning my integrity, which is something I cannot accept.</p>
</div>
<div class="paragraph">
<p>In practice, since Gradle announced a couple of years back that they would start using Kotlin as a language for its DSL, I&#8217;ve been in a very complicated position.
Privately, I always get pinged whenever I say something good about Kotlin. Like, you should not do this, this is not good for us, or, Gradle is not nice with Groovy, what are you doing.
People always make jokes about Kotlin when they talk to me. I was at Gr8Conf Europe a few days after the announcement and man, that wasn&#8217;t a pleasant experience.</p>
</div>
<div class="paragraph">
<p>I am Cédric. I am not Gradle Inc.</p>
</div>
<div class="paragraph">
<p>I am Cédric. I am not Kotlin.</p>
</div>
<div class="paragraph">
<p>I am Cédric. I am not Groovy.</p>
</div>
<div class="paragraph">
<p>Technologies live and die, I&#8217;m not interested in being married with a technology, I&#8217;m interested in working with something that excites me.
The reality is that I&#8217;ve been more excited with Kotlin than Groovy lately, and the attacks, conscious or not, public or private, that I get everytime I mention this language are tiring.</p>
</div>
<div class="paragraph">
<p>Now, when I&#8217;m going to say something good about Groovy, I hope folks will believe me.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_special_thanks">Special thanks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I want to thank Guillaume Laforge for this adventure. Man, you gave me the opportunity to join the project, its awesome community. You gave me a job, I was lucky enough to be paid to work on open-source software, and that&#8217;s all because of you. For that I owe you everything, thank you!</p>
</div>
<div class="paragraph">
<p>Second, thanks to Paul King. You are the one that the Groovy community should never loose. People have mentioned that I would be a great loss, but that&#8217;s not true: the reality is that I contributed almost nothing recently, and you did all the hard work. You are also an amazing person always trying to get the best of us. I will miss it.</p>
</div>
<div class="paragraph">
<p>Then Jochen Theodorou: thanks to you for all the hard work you&#8217;ve done with the compiler. I would not have been able to write the static compiler without your help and insights on the internals of Groovy.</p>
</div>
<div class="paragraph">
<p>I&#8217;d also would like to personally thank folks that make the community vibrant: Søren Berg Glasius, Graeme Rocher, Jeff Scott Brown, Iván López, Álvaro Sánchez and all the others I miss, don&#8217;t take it personally, this is not easy for me.</p>
</div>
<div class="paragraph">
<p>Last but not least, thank you to the Groovy community. You&#8217;ve been awesome, and I wouldn&#8217;t be where I am without you. I may have been a bit sharp saying that the Groovy community as a whole sees me as a Trojan horse, that&#8217;s not true, but the truth is that I don&#8217;t want to fight anymore. Do not assume that because I quit the community is toxic: it&#8217;s not. There&#8217;s just a lot of understandable fear for the future, in my opinion. My advice is, embrace the change, don&#8217;t look back, and take inspiration.</p>
</div>
<div class="paragraph">
<p>I want to say good luck to the team, in particular to its newer members, like Daniel Sun, who are the future of this language: they have the energy, the skills to make it better.</p>
</div>
<div class="paragraph">
<p>Last but not least, I&#8217;m still a <a href="https://opencollective.com/friends-of-groovy">friend of Apache Groovy</a>, you should be too!</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2019/03/goodbye-groovy.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2019/03/simple-http-server-graal.html"><h1>A simple native HTTP server with GraalVM</h1></a>
  			<p>19 mars 2019</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/gradle.html">gradle</a> 
	
		<a href="/blog/tags/graal.html">graal</a> 
	
		<a href="/blog/tags/groovy.html">groovy</a> 
	
		<a href="/blog/tags/kotlin.html"> kotlin</a> 
	</p>
			
  			<p><div class="sect1">
<h2 id="_writing_a_simple_http_server_with_graalvm">Writing a simple HTTP server with GraalVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In my daily work, I often need to start a simple HTTP server to serve local files.
For example, this week I&#8217;m going to give a talk at <a href="https://www.breizhcamp.org">Breizcamp</a>, and because my presentation uses a <a href="https://revealjs.com">Reveal.js slide deck</a> and that it loads resources dynamically, I need a "real" web server to serve the files.
So far, I&#8217;ve been quite happy using the Python simple http server.
Using it is as easy as running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>python -m SimpleHTTPServer 8000</code></pre>
</div>
</div>
<div class="paragraph">
<p>But knowing that the JDK has an embedded HTTP server, and that there&#8217;s a lot of hype around Graal those days, I wanted to see if we could achieve the same thing, with a fast startup, with GraalVM.
The answer is <strong>yes</strong>, but the road wasn&#8217;t so easy, at least for Groovy.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_show_me_the_code">Show me the code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code for this experiment can be found on <a href="https://github.com/melix/graal-simple-httpserver">GitHub</a>.
We&#8217;re going to use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://gradle.org/">Gradle</a> to build</p>
</li>
<li>
<p>the <a href="https://github.com/palantir/gradle-graal">Gradle Graal plugin</a> from Palantir</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And because I like the <a href="http://www.groovy-lang.org/">Groovy</a>, and especially its static compiler, my first attempt was to use statically compiled Groovy to do this.
Well, it turned out to become a nightmare, so after an hour trying to make it work, I switched to Kotlin, and try to make it work there first.
Knowing that Kotlin is a statically compiled language from the ground up and that it doesn&#8217;t have the whole dynamic history of Groovy, I did expect it to be simpler.</p>
</div>
<div class="paragraph">
<p>So, in the end, here&#8217;s what the Kotlin server looks like:</p>
</div>
<div class="listingblock">
<div class="title">HttpServer.kt</div>
<div class="content">
<pre class="prettyprint ruby language-ruby"><code>fun main(args: Array&lt;String&gt;) {
    val port = if (args.size &gt; 0) args[0].toInt() else 8080
    val baseDir = if (args.size &gt; 1) File(args[1]).canonicalFile else File(".").canonicalFile

    create(InetSocketAddress(port), 0).run {
        createContext("/") { exchange -&gt;
            exchange.run {
                val file = File(baseDir, requestURI.path).canonicalFile
                if (!file.path.startsWith(baseDir.path)) {
                    sendResponse(403, "403 (Forbidden)\n")
                } else if (file.isDirectory) {
                    val base = if (file == baseDir) "" else requestURI.path
                    sendResponse(200, "&lt;html&gt;&lt;body&gt;" +
                            file.list()
                                .map { "&lt;ul&gt;&lt;a href=\"$base/${it}\"&gt;${it}&lt;/a&gt;&lt;/ul&gt;" }
                                .joinToString("\n") + "&lt;/body&gt;&lt;/html&gt;")

                } else if (!file.isFile) {
                    sendResponse(404, "404 (Not Found)\n")
                } else {
                    sendResponse(200) {
                        FileInputStream(file).use {
                            it.copyTo(this)
                        }
                    }
                }
            }
        }
        executor = null
        println("Listening at http://localhost:$port/")
        start()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s quite simple indeed, and making this work as a GraalVM native image is extremely easy too. This is the <em>whole build file</em>, this is all you need:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle.kts</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>plugins {
   kotlin("jvm") version "1.3.21"
   id("com.palantir.graal") version "0.3.0-6-g0b828af"
}

repositories {
   jcenter()
}

dependencies {
   implementation(kotlin("stdlib"))
}

graal {
   graalVersion("1.0.0-rc14")
   mainClass("HttpServerKt")
   outputName("httpserv-kt")
   option("--enable-http")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we just apply the Kotlin plugin to build our code, then the GraalVM plugin and configure the basics of the GraalVM plugin (version, main class, &#8230;).</p>
</div>
<div class="paragraph">
<p>Building the image can be done by calling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>./gradlew http-kotlin:nativeImage</code></pre>
</div>
</div>
<div class="paragraph">
<p>As <a href="https://scans.gradle.com/s/nzkvn2gwkguf6">you can see</a>, building the whole thing takes around 15s on my laptop.
That is to say, compiling the server <strong>and</strong> generating the native image.
Then you can try to serve files running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>http-kotlin/build/graal/httpserv-kt 9090 /path/to/files</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see that the server starts immediately: there&#8217;s absolutely no wait time, it&#8217;s there and ready to answer.
The whole process took me less than 30 minutes, the native image is only 11MB. Success!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_making_it_work_with_groovy">Making it work with Groovy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that I had a proof-of-concept with Kotlin, I went back to Groovy.
And, I can say, despite the fact I love this language, that it was a nightmare to make it work.
At some point, I even thought of abandoning, however, using perseverance, I managed to work around all problems I faced.</p>
</div>
<div class="paragraph">
<p>Before I explain the problems, let&#8217;s took a look at the final Groovy server:</p>
</div>
<div class="listingblock">
<div class="title">HttpServerGroovy.groovy</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>@CompileStatic
abstract class HttpServerGroovy {

    // VERY dirty trick to avoid the creation of a groovy.lang.Reference
    static File baseDir

    static void main(String[] args) {
        def port = args.length &gt; 0 ? args[0].toInteger() : 8080
        baseDir = args.length &gt; 1 ? new File(args[1]).canonicalFile : new File(".").canonicalFile

        def server = HttpServer.create(new InetSocketAddress(port), 0)
        server.createContext("/", new HttpHandler() {
            @Override
            void handle(HttpExchange exchange) throws IOException {
                def uri = exchange.requestURI
                def file = new File(baseDir, uri.path).canonicalFile
                if (!file.path.startsWith(baseDir.path)) {
                    sendResponse(exchange, 403, "403 (Forbidden)\n")
                } else if (file.directory) {
                    String base = file == baseDir ? '': uri.path
                    String listing = linkify(base, file.list()).join("\n")
                    sendResponse(exchange, 200, String.format("&lt;html&gt;&lt;body&gt;%s&lt;/body&gt;&lt;/html&gt;", listing))

                } else if (!file.file) {
                    sendResponse(exchange, 404, "404 (Not Found)\n")
                } else {
                    sendResponse(exchange, 200, new FileInputStream(file))
                }
            }
        })
        server.executor = null
        System.out.println(String.format("Listening at http://localhost:%s/", port))
        server.start()
    }

    private static List&lt;String&gt; linkify(String base, String[] files) {
        def out = new ArrayList&lt;String&gt;(files.length)
        for (int i = 0; i &lt; files.length; i++) {
            String file = files[i]
            out &lt;&lt; String.format("&lt;ul&gt;&lt;a href=\"%s/%s\"&gt;%s&lt;/a&gt;&lt;/ul&gt;", base, file, file)
        }
        out
    }
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first thing you will notice is that it&#8217;s far from being idiomatic Groovy.
Of course I used <code>@CompileStatic</code>, because the static nature of GraalVM would have made this an even greater challenge to make it work with dynamic Groovy.
However, I didn&#8217;t expect that it would be <em>so hard</em> to make it work.
The resulting file is both a consequence of limitations of GraalVM, and historical background of Groovy.</p>
</div>
<div class="sect2">
<h3 id="_where_are_my_closures">Where are my closures?</h3>
<div class="paragraph">
<p>The first code I wrote was using idiomatic Groovy, with closures. However, as soon as I started to build my native image, I noticed this obscure error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>com.oracle.graal.pointsto.constraints.UnsupportedFeatureException: Invoke with MethodHandle argument could not be reduced to at most a single call: java.lang.invoke.MutableCallSite.&lt;init&gt;(MethodHandle)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s funny to see this <code>MethodHandle</code> error when you know that the code is <em>fully statically compiled</em>, and that it doesn&#8217;t contain a single method handle.
However, the Groovy runtime does, and this is where the fun began.
First of all, GraalVM tells you what method is problematic. This was <code>org.codehaus.groovy.vmplugin.v7.IndyInterface.invalidateSwitchPoints</code>.
Things are getting a little clearer: for some reason, the Groovy runtime is initialized, and we load the dynamic <code>IndyInterface</code>, that I won&#8217;t ever need.</p>
</div>
<div class="paragraph">
<p>The "some reason" needs a bit of explanation. Despite the fact that we use statically compiled Groovy, we&#8217;re still implementing <em>Groovy specific interfaces</em>. For example, the <code>GroovyObject</code> interface.
Similarly, we honor class initialization the same way as a dynamic class, meaning that when a statically compiled Groovy class is instantiated, even if it doesn&#8217;t contain any dynamic reference, we will initialize its metaclass, and as a consequence try to initialize the Groovy runtime.</p>
</div>
<div class="paragraph">
<p>However something was <em>wrong</em>: looking at my code I could not figure out what would cause initialization, because my entry point was static.
In fact, the answer was easy: it came through the closures.</p>
</div>
<div class="paragraph">
<p>Well, that&#8217;s what I thought, because even after eliminating closures, I still got the damn error.
In fact, it turns out the situation is far more complex.
For example, I had this innocent looking code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>def baseDir = args[0]
server.createContext("/", new HttpHandler() {
    @Override
    void handle(HttpExchange exchange) throws IOException {
        ...
        someCodeUses(baseDir)
    })</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fact that we use <code>baseDir</code> <em>within</em> an anonymous inner class, and that Groovy uses the same code generation under the hood for both closures and anonymous inner classes, that the <code>baseDir</code> variable is allowed to be mutated in the inner class. Of course here I&#8217;m not doing it, but because the compiler doesn&#8217;t eliminate that possibility, what it does is generating a <code>groovy.lang.Reference</code> for my local variable, that is used in the inner class.
And, initializing the <code>Reference</code> class would cause an additional path to this <code>IndyInterface</code> method call&#8230;</p>
</div>
<div class="paragraph">
<p>In the end, the problem is not that much that there&#8217;s a <code>MethodHandle</code>, it&#8217;s that there are potentially different code paths that lead to this, and that GraalVM can&#8217;t figure out in the end a single method to be called: we&#8217;re just defeating the system!</p>
</div>
<div class="paragraph">
<p>For example, even creating an anonymous inner class would still trigger the creation of a metaclass for it: this means that even if we replace the closure with an inner class, in the end, we would still trigger the initialization of the Groovy runtime.</p>
</div>
<div class="paragraph">
<p>I tried to be smart and remove the <code>IndyInterface</code> from the code that GraalVM is using to generate the native image, knowing that in the end, this code would <em>never</em> be called if I didn&#8217;t register the Java 7 plugin (that I wouldn&#8217;t use in any case). However, it turns out that GraalVM doesn&#8217;t like this, as it has special handling for Groovy, and that if you <em>remove</em> that class, it fails with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>Error: substitution target for com.oracle.svm.polyglot.groovy.Target_org_codehaus_groovy_vmplugin_v7_IndyInterface_invalidateSwitchPoints is not loaded. Use field `onlyWith` in the `TargetClass` annotation to make substitution only active when needed.</code></pre>
</div>
</div>
<div class="paragraph">
<p>So instead I spent hours eliminating those paths, which involved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>turning that shared variable into a field in order to workaround the reference initialization</p>
</li>
<li>
<p>removing all closures</p>
</li>
<li>
<p>removing usages of <code>GString</code> (interpolated strings, which is why you see <code>String.format</code> instead)</p>
</li>
<li>
<p>replacing the short-hand syntax for creating lists (<code>def foo=[]</code>) with an explicit call</p>
</li>
<li>
<p>removing calls to <code>+</code> with strings (first attempt to remove GString&#8230;)</p>
</li>
<li>
<p>eliminating some classes from the Groovy runtime</p>
</li>
<li>
<p>replacing some classes of the Groovy runtime with stubs, preventing static initialization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the end, I have <a href="https://github.com/melix/graal-simple-httpserver/blob/master/http-groovy/build.gradle.kts">something which works</a>, but you can see that the build file is far more complex.</p>
</div>
<div class="paragraph">
<p>In particular, it makes use of a little known Gradle feature called <em>artifact transforms</em>. Basically, I&#8217;m asking Gradle to transform the Groovy jar <em>before</em> GraalVM uses it. This transformation involves filtering out classes, so that GraalVM doesn&#8217;t try to be too smart about them.</p>
</div>
<div class="paragraph">
<p>Once this is done, we can finally generate a native image for Groovy too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>./gradlew http-groovy:nativeImage</code></pre>
</div>
</div>
<div class="paragraph">
<p>It takes about <a href="https://scans.gradle.com/s/p4ctmi5pzune4">the same amount of time as with Kotlin</a> to generate a similar 11MB native image.
Running it is as easy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>http-groovy/build/graal/httpserv-groovy 9090 /path/to/files</code></pre>
</div>
</div>
<div class="paragraph">
<p>And again it&#8217;s super snappy!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this stage, you might consider that it&#8217;s a success: we got both Kotlin and Groovy code compiled into a native image that is very snappy and starts even faster than the Python server.
However, getting the Groovy version to work was <em>hours of pain</em>. Each time I managed to fix a problem, another one arose.
Basically, every method call, every extension method you call is likely to trigger initialization of some Groovy subsystem, or trigger additional paths to this <code>IndyInterface</code> code.
In the end it would be nice if GraalVM could completely eliminate the need for having this class, but until then I just cannot recommend anyone to use Groovy to build native images: it&#8217;s just <em>too frustrating</em>.
And remember that even if you manage to make it work, it takes both a significant amount of time to do so, but also forces you to write non idiomatic code.
Last but not least, <em>any</em> addition to your code is likely to force you to update your GraalVM configuration to make it work.
In the end, it&#8217;s just way easier to write plain old Java code, or go Kotlin.</p>
</div>
<div class="paragraph">
<p>Note that I&#8217;m not saying that it&#8217;s not possible with Groovy, but <a href="https://e.printstacktrace.blog/graalvm-and-groovy-how-to-start/">folks usually face different problems than I did</a>, in particular when it&#8217;s just about configuring classes accessed by reflection: this is a simple problem.
I&#8217;m not saying either that you should avoid Groovy: I just think it&#8217;s not suited for this use case. I still use Groovy everyday, in particular in tests or for simple scripts (in replacement to bash scripts). However, more worrisome is that if an application transitively depends on Groovy, it&#8217;s unlikely to be "GraalVM compatible".</p>
</div>
<div class="paragraph">
<p>Eventually, if you look at the Kotlin version and the companion Gradle build, it&#8217;s extremely simple, thanks to the great work done by the Palantir team!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
After this blog post was published, I received a <a href="https://github.com/melix/graal-simple-httpserver/pull/1">pull request from Szymon Stepniak</a> improving the Groovy code a lot. The resulting file is, however, twice as big (23MB!). It does <em>not</em> change my vision on this either, because it took 2 men to reach this point, in a significant amount of time.
</td>
</tr>
</table>
</div>
</div>
</div></p>
			<p><a href="/blog/2019/03/simple-http-server-graal.html#disqus_thread">Comments</a></p>
	
	<hr />
        <a href="/blog/help-me.html" class="help-banner">If you like this blog or my talks, consider helping me acquire astronomy equipment</a>
	
	<p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.0.3</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/blog/js/jquery-1.9.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
    <script src="/blog/js/run_prettify.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
    var disqus_shortname = 'melixblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45962373-1', 'melix.github.io');
  ga('send', 'pageview');

</script>
<script src="http://cdn.lanyrd.net/badges/person-v1.min.js"></script>
  </body>
</html>
